# iptables

## ---- Disclaimer ---- ##

_Hints for working with iptables. Has been done just to make myself easier to work with iptables. Link to an original materials below_

_Thanks for [**setevoy**](https://rtfm.co.ua/author/setevoy/) for his great work_

**Original list of articles** [here](https://rtfm.co.ua/linux-iptables-rukovodstvo-chast-1-osnovy-iptables/)


## *

*iptables -- utility*

*Netfilter -- firewall*


## [!] Tables

### filter
*default* table

|      chain     |             description             |
|:--------------:|:-----------------------------------:|
|    **INPUT**   |      destination - local server     |
|    **OUTPUT**  |       packets created locally       |
|   **FORWARD**  | packets for other network interface |


### nat
Use for _Network Address Translation_

Processes **only first** package from the stream, and apply the same changes on others packets **automatically** => not use  **any filtering** here

|      chain      |                  description                  |
|:---------------:|:---------------------------------------------:|
|  **PREROUTING** | _**Destination**_ Network Address Translation |
|    **OUTPUT**   |       NAT for locally generated packets       |
| **POSTROUTING** |    _**Source**_ Network Address Translation   |

### mangle
Use for _changing some headers_ if need so **only**

- TOS (Type of Service)
- TTL (Time to Live)
- MARK

|     chain       |                       description                         |
|:---------------:|:---------------------------------------------------------:|
|  **PREROUTING** |              Processing **_all_** incoming packets        |
|   **INPUT**     |  For **_locally addressed_** packets : for client/server  |
|  **FORWARD**    |      Incoming packets, which then routes to the "exit"    |
|   **OUTPUT**    |         Packets, **_generated by local processes_**       |
| **POSTROUTING** |            Processing **_all_** outgoing packets          |


### raw
Apply before _connection tracking & packet state define_

Analyzes all packets instead of _NOTRACK_ in _raw_

|      chain      |                  description                  |
|:---------------:|:---------------------------------------------:|
|  **PREROUTING** |                                               |
|    **OUTPUT**   |                                               |


## Scheme

![alt text](http://rtfm.co.ua/wp-content/uploads/2014/10/iptables_packet_flow.png "Packets flow")


## [!] Targets

``-j, --jump TARGET [CHAIN]`` - action _TARGET_ [ _CHAIN_ ] perform to a packet(s)

``-g, --goto CHAIN`` - continue processing in a _CHAIN_

|     target     |                                                           description                                                          | tables | chains                             | example                                                                                                                                                                                                                                                                               |
|:--------------:|:------------------------------------------------------------------------------------------------------------------------------:|--------|------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|   **ACCEPT**   |                                                accept packet & continue routing                                                |        |                                    |                                                                                                                    ``iptables -A INPUT -s SOME_IP_HERE -j ACCEPT``                                                                                                                    |
|    **DNAT**    |  _Destination Network Address Translation_<br/> change **_destination IP_** in packet header<br/>  *in the same packets flow*  |   nat  |       PREROUTING<br/>  OUTPUT      |                                                                                  ``iptables -t nat -A PREROUTING -p tcp -d 15.45.23.67 --dport 80 -j DNAT --to-destination 192.168.1.1-192.168.1.10``                                                                                 |
|    **SNAT**    |       _Source Network Address Translation_<br/> change **_source IP_** in packet header <br/> *in the same packets flow*       |   nat  |             POSTROUTING            |                                                                                     ``iptables -t nat -A POSTROUTING -p tcp -o eth0 -j SNAT --to-source 194.236.50.155-194.236.50.160:1024-32000``                                                                                    |
|    **DROP**    |                                           drop packet & make iptables forget about it                                          |        |                                    |                                                                                                                                                                                                                                                                                       |
|   **REJECT**   |                                  drop packet & **_return error message_**<br/>  to the sender                                  |        |                                    |  ``iptables -A FORWARD -p TCP --dport 22 -j REJECT --reject-with tcp-reset``<br/> `` - icmp-net-unreachable``<br/> `` - icmp-host-unreachable``<br/> `` - icmp-port-unreachable``<br/> `` - icmp-proto-unreachable``<br/> `` - icmp-net-prohibited``<br/> `` - icmp-host-prohibited`` |
|   **RETURN**   |                           return to next rule in the calling<br/>  (previous) chain; or apply POLICY                           |        |                                    |                                                                                                                                                                                                                                                                                       |
| **MASQUERADE** |                                            same as SNAT, but for dynamic addressing                                            |   nat  |             POSTROUTING            |                                                                                                     ``iptables -t nat -A POSTROUTING -p TCP -j MASQUERADE --to-ports 1024-31000``                                                                                                     |
|    **MARK**    |                                                 mark packets while its routing                                                 | mangle |                                    |                                                                                                      ``iptables -t mangle -A PREROUTING -p tcp --dport 22 -j MARK --set-mark 2``                                                                                                      |
|  **CONNMARK**  |                                               mark packets in connection/session                                               | mangle |                                    |                        ``iptables -t nat -A PREROUTING -p tcp --dport 80 -j CONNMARK --set-mark 4``<br/> ``iptables -t mangle -A PREROUTING --dport 80 -j CONNMARK --save-mark``<br/> ``iptables -t mangle -A PREROUTING --dport 80 -j CONNMARK --restore-mark``                      |
|   **MIRROR**   |                                          exchange  **_source_** and  **_destination_**                                         |        | INPUT<br/> FORWARD<br/> PREROUTING |                                                                                                                                                                                                                                                                                       |
|    **QUEUE**   |                                                push packet to some process queue                                               |        |                                    |                                                                                                                                                                                                                                                                                       |
|  **REDIRECT**  |                                     redirect packet to another<br/>  port of the same host                                     |   nat  |       PREROUTING<br/> OUTPUT       |                                                        ``iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080``<br/> ``iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080-9090``                                                      |
|     **TOS**    |                                  change 8-bit Type-of-Service <br/> field in packet IP header                                  |        |                                    |                                                                                                                                                                                                                                                                                       |
|     **TTL**    |                                       change Time-to-Live <br/> field in packet IP header                                      |        |                                    |                                                                                                                                                                                                                                                                                       |
|     **LOG**    |                                       Log to system journal: <br/> **dmesg** **syslogd**                                       |        |                                    |                 ``iptables -A FORWARD -p tcp -j LOG --log-level debug``<br/> ``iptables -A INPUT -p tcp -j LOG --log-prefix "INPUT packets"``<br/> ``iptables -A INPUT -p tcp -j LOG --log-tcp-sequence``<br/> ``iptables -A FORWARD -p tcp -j LOG --log-tcp-options``                |
|    **ULOG**    |                                                 log to MySQL DB, csv, xml, etc.                                                |        |                                    |                                                                                                                                                                                                                                                                                       |


## [!] Criteria

|    state    |            description                       |          |
|:-----------:|:--------------------------------------------:|:--------:|
|     NEW     |               opens new session              | TCP: SYN |
| ESTABLISHED |           part of existing session           |          |
|   RELATED   | new session belongs to **_existed_** session |          |
|   INVALID   |               all other packets              |          |


## [!] Commands

``iptables -S`` rules list

``iptables -N new_chain`` **_creates new_** chain with name _new_chain_

``iptables -L new_chain`` **_lists rules_** in _new_chain_

``iptables -E new_chain next_chain`` **_renames_** _new_chain_ to _next_chain_

``iptables -X next_chain`` **_deletes_** _next_chain_

``iptables -A some_chain`` **_appends new rule_** to the end of _some_chain_

``iptables -I some_chain 1 -s 192.168.100.100 -j ACCEPT`` **_input_** rule _-s 192.168.100.100 -j ACCEPT_ to _some_chain_ on the **_1_** position

``iptables -D some_chain 1`` **_deletes rule_** from _some_chain_ with **_position 1_**

``iptables -D some_chain -s 192.168.100.100 -j ACCEPT`` **_deletes rule_** _-s 192.168.100.100 -j ACCEPT_ from _some_Chain_

``iptables -P some_chain some_target`` **_set default policy_** for _some_chain_


## [!] Rules Parameters

|                    parameter                   |                                       description                                      |                                                                                                                                                                                                                                                                                                       example |
|:----------------------------------------------:|:--------------------------------------------------------------------------------------:|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|           ``-p``<br/> ``--protocol``           |                                     /etc/protocols                                     |                                                                                                                                                                                                                                                                                  ``iptables -A INPUT -p tcp`` |
|    ``-s``<br/>  ``--src``<br/>  ``--source``   |                                     source address                                     |                                                                                                                                                                                                                             ``iptables -A INPUT -s 192.168.1.1``<br/>  ``iptables -A INPUT -s ! 192.168.1.1`` |
| ``-d``<br/>  ``--dst``<br/>  ``--destination`` |                               destination <br/>  address                               |                                                                                                                                                                                                                             ``iptables -A INPUT -d 192.168.1.1``<br/>  ``iptables -A INPUT -d ! 192.168.1.1`` |
|         ``-i``<br/>  ``--in-interface``        | input traffic <br/>  on interface; <br/>  PREROUTING <br/>  INPUT <br/>  FORWARD <br/> |                                                                                                                                                                                                       ``iptables -A INPUT -i eth0``<br/>  ``iptables -A INPUT -i eth+``<br/>  ``iptables -A INPUT -i ! eth0`` |
|         ``-o``<br/> ``--out-interface``        |  output traffic<br/>  on interface;                                                    |                                                                                                                                                                                                    ``iptables -A OUTPUT -o eth0``<br/>  ``iptables -A OUTPUT -o eth+``<br/>  ``iptables -A OUTPUT -o ! eth0`` |
|                                                | **TCP / UDP**                                                                          |                                                                                                                                                                                                                                                                                                               |
|       ``--sport``<br/>  ``--source-port``      | source port<br/>  service name                                                         |     /etc/services<br/>  ``iptables -A INPUT -p tcp [-p udp] --sport 22``<br/>  ``iptables -A INPUT -p tcp [-p udp] --sport ssh``<br/>  ``iptables -A INPUT -p tcp [-p udp] --sport 80:1024``<br/>  ``iptables -A INPUT -p tcp [-p udp] --sport :80``<br/>  ``iptables -A INPUT -p tcp [-p udp] --sport ! 80`` |
|    ``--dport``<br/>  ``--destination-port``    | destination port<br/>  service name                                                    | /etc/services<br/>  ``iptables -A OUTPUT -p tcp [-p udp] --dport 22``<br/>  ``iptables -A OUTPUT -p tcp [-p udp] --dport ssh``<br/>  ``iptables -A OUTPUT -p tcp [-p udp] --dport 80:1024``<br/>  ``iptables -A OUTPUT -p tcp [-p udp] --dport :80``<br/>  ``iptables -A OUPUT -p tcp [-p udp] --dport ! 80`` |
|                                                | **TCP**                                                                                |                                                                                                                                                                                                                                                                                                               |
|                 ``--tcp-flags``                | when tcp flags <br/> specified                                                         |                                                                                                                                                                                                                                                               ``iptables -p tcp --tcp-flags SYN,FIN,ACK SYN`` |
|                                                | ICMP                                                                                   |                                                                                                                                                                                                                                                                                                               |
|                 ``--icmp-type``                | icmp types [link](http://www.informit.com/articles/article.aspx?p=26557&seqNum=5)   |                                                                                                                                                                                                                                                                   ``iptables -A INPUT -p icmp --icmp-type 8`` |


## [!] Modules & Parameters

``-m module_name``

|        module        |                                                                                                         description                                                                                                        |                                                                                                                                  example                                                                                                                                 |
|:--------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|    ``-m addrtype``   |                                                                                         address filtering<br> --src-type/--dst-type                                                                                        |                                          ``iptables -A INPUT -m addrtype --src-type UNICAST``<br/> ``iptables -A INPUT -m addrtype --src-type ! UNICAST``<br/> ``iptables -A INPUT -m addrtype --src-type MULTICAST, BROADCAST``                                         |
|    ``-m comment``    |                                                                                          add comment to a filter  <br/> len <= 256                                                                                         |                                                                                                       ``iptables -A INPUT -m comment --comment "This is comment"``                                                                                                       |
| ``-m connmark``<br/> |                                                                                                action if _mark_ is set <br/>                                                                                               |                                                                                                           ``iptables -A INPUT -m connmark --mark 12 -j ACCEPT``                                                                                                          |
|    ``-m iprange``    |                                                greater than just ``--source`` <br/> and ``--destination`` <br/> allow to set an IP range <br/> ``--src-range/--dst-range``                                                 |                                                                                               ``iptables -A INPUT -p tcp -m iprange --src-range 192.168.1.13-192.168.2.19``                                                                                              |
|     ``-m length``    |                                                                                                   filter by packet length                                                                                                  |                                                                           ``iptables -A INPUT -p tcp -m length --length 1400``<br/>  ``iptables -A INPUT -p tcp -m length --length 1400:1500``                                                                           |
|     ``-m limit``     |                                               packets count in a time <br/> ``--limit`` - rate of counter increases<br/> ``--limit-burst`` - count of packets<br/> in a time                                               |                                                                                                               ``iptables -A INPUT -m limit --limit 3/hour``                                                                                                              |
|      ``-m mac``      |                                                                               MAC-address filtering <br/> PREROUTING<br/> FORWARD<br/> INPUT                                                                               |                                                                                                        ``iptables -A INPUT -m mac --mac-source 00:00:00:00:00:01``                                                                                                       |
|      ``-m mark``     |                                                                                _mark_ specified filtering <br/> _mark_ set by CONNMARK/MARK                                                                                |                                                                                                             ``iptables -t mangle -A INPUT -m mark --mark 1``                                                                                                             |
|   ``-m multiport``   |                                        filter by several ports<br/> ``--source-port`` / ``--destination-port`` <br/> ``--port`` - max 15 ports<br/>require ``-p tcp`` or ``-p udp``                                        |                                                                                                 ``iptables -A INPUT -p tcp -m multiport --destination-port 22,53,80,110``                                                                                                |
|     ``-m owner``     | filter by the packet owner<br/> ``--cmd-owner`` - service name<br/> ``--uid-owner`` - UID, User ID<br/> ``--gid-owner`` - GID, Group ID<br/> ``--pid-owner`` - PID, Process ID<br/> ``--sid-owner`` - SID, Service ID<br/> |  ``iptables -A OUTPUT -m owner --cmd-owner httpd``<br/> ``iptables -A OUTPUT -m owner --uid-owner 500``<br/> ``iptables -A OUTPUT -m owner --gid-owner 0``<br/> ``iptables -A OUTPUT -m owner --pid-owner 78``<br/> ``iptables -A OUTPUT -m owner --sid-owner 100``<br/> |
|    ``-m pkttype``    |                                                                      filter by packet addressing type<br/> UNICAST<br/> BROADCAST<br/> MULTICAST<br/>                                                                      |                                                                                                           ``iptables -A OUTPUT -m pkttype --pkt-type unicast``                                                                                                           |
|     ``-m state``     |                                                                filter by connection state:<br/>   - NEW<br/>  - ESTABLISHED<br/>  - RELATED<br/>  - INVALID                                                                |                                                                                                        ``iptables -A INPUT -m state --state RELATED,ESTABLISHED``                                                                                                        |
